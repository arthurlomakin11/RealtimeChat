variables:
  - group: GitHubSecrets

steps:
  - checkout: none # Disable automatic checkout

  - script: |
      echo Cloning Azure DevOps repo (master branch only)...
      git clone -b master --single-branch https://desktop-ktppcj0:8443/Default/RealtimeChat/_git/RealtimeChat azure-repo
      cd azure-repo

      echo Adding GitHub as remote...
      git remote add github https://$(GITHUB_TOKEN)@github.com/arthurlomakin11/RealtimeChat.git
      git fetch github

      echo Attempting merge...
      if git merge github/master --no-edit --no-commit; then
        echo Merge successful
        git commit -m "Auto-merge from GitHub [skip ci]"
        git push origin master
      else
        echo ##vso[task.logissue type=warning]Merge conflict - forcing changes
        git merge --abort
        git reset --hard github/master
        git push origin master --force-with-lease
      fi
    displayName: 'Sync from GitHub (manual clone)'
    env:
      GITHUB_TOKEN: $(GITHUB_TOKEN)